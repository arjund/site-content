<h1 id="javalite-db-migrator-is-a-database-migration-system-for-java">JavaLite DB-Migrator is a database migration system for Java</h1>
<p>Database migrations is a process of making changes to database schema during a development process. See <a href="http://en.wikipedia.org/wiki/Schema_migration">Schema_migration</a> to understand better what database migrations are.</p>
<h2 id="db-migrator-is-maven-plugin">DB-Migrator is Maven plugin</h2>
<p>Current implementation of this project is a Maven Plugin. Future releases will include a standalone library for non-Maven projects.</p>
<p>Please, see <a href="#maven-configuration">Maven configuration</a></p>
<h2 id="how-to-use">How to use</h2>
<p>Generate a new migration:</p>
<pre class="prettyprint"><code>mvn db-migrator:new -Dname=create_people_table</code></pre>
<p>will result in:</p>
<pre class="prettyprint"><code>...
[INFO] Created new migration: src/migrations/20140211113507_create_people_table.sql
...</code></pre>
<p>This creates an empty file. Go ahead and add raw SQL to the file</p>
<pre class="prettyprint"><code>create table people ( name varchar (10));</code></pre>
<p>Run migration:</p>
<pre class="prettyprint"><code>mvn db-migrator:migrate
...
[INFO] Migrating jdbc:mysql://localhost/test_project using migrations at src/migrations/
[INFO] Migrating database, applying 1 migration(s)
[INFO] Running migration 20140211113507_create_people_table.sql</code></pre>
<p>Alternatively, you can just run the build.</p>
<h2 id="all-other-goals">All other goals</h2>
<p>You can execute plugin help goal to get all information on all other goals:</p>
<pre class="prettyprint"><code>mvn  db-migrator:help
...
[INFO] db-migrator:drop
[INFO]   drops database configured in pom
[INFO] db-migrator:create
[INFO]   creates database configured in pom
[INFO] db-migrator:new
[INFO]   creates a new migration file
[INFO] db-migrator:check
[INFO]   checks that no pending migrations remain. This can be used in build lifecycle to fail the build if pending migrations are found
[INFO] db-migrator:migrate
[INFO]   migrates all pending migrations
[INFO] db-migrator:validate
[INFO]   validates and prints a report listing pending migrations
[INFO] db-migrator:reset
[INFO]   drops/re-creates the database, and runs all migrations, effectively resetting database to pristine state
[INFO] db-migrator:help
[INFO]   prints this message</code></pre>
<h2 id="where-to-get">Where to get</h2>
<p>Generally, just add a plugin configuration to your pom, as described below. If you want to download, you can do so here: <a href="http://search.maven.org/#search%7Cga%7C1%7Ca%3A%22db-migrator-maven-plugin%22">db-migrator-maven-plugin</a></p>
<h2 id="maven-configuration">Maven configuration</h2>
<p>Here is an example of simple configuration:</p>
<pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;plugin&gt;</span>
    <span class="kw">&lt;groupId&gt;</span>org.javalite<span class="kw">&lt;/groupId&gt;</span>
    <span class="kw">&lt;artifactId&gt;</span>db-migrator-maven-plugin<span class="kw">&lt;/artifactId&gt;</span>
    <span class="kw">&lt;version&gt;</span>1.4.9<span class="kw">&lt;/version&gt;</span>
    <span class="kw">&lt;configuration&gt;</span>
        <span class="kw">&lt;driver&gt;</span>com.mysql.jdbc.Driver<span class="kw">&lt;/driver&gt;</span>
        <span class="kw">&lt;url&gt;</span>jdbc:mysql://localhost/test_project<span class="kw">&lt;/url&gt;</span>
        <span class="kw">&lt;username&gt;</span>your user<span class="kw">&lt;/username&gt;</span>
        <span class="kw">&lt;password&gt;</span>your password<span class="kw">&lt;/password&gt;</span>
    <span class="kw">&lt;/configuration&gt;</span>
    <span class="kw">&lt;dependencies&gt;</span>
        <span class="kw">&lt;dependency&gt;</span>
            <span class="kw">&lt;groupId&gt;</span>mysql<span class="kw">&lt;/groupId&gt;</span>
            <span class="kw">&lt;artifactId&gt;</span>mysql-connector-java<span class="kw">&lt;/artifactId&gt;</span>
            <span class="kw">&lt;version&gt;</span>5.1.25<span class="kw">&lt;/version&gt;</span>
        <span class="kw">&lt;/dependency&gt;</span>
    <span class="kw">&lt;/dependencies&gt;</span>
<span class="kw">&lt;/plugin&gt;</span></code></pre>
<p>In a more realistic project, you will have more than one database, such as test, development, production, etc. In order to migrate multiple databases, use Maven executions:</p>
<p>First, configure the plugin in <code>pluginManagement</code>:</p>
<pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;pluginManagement&gt;</span>
    <span class="kw">&lt;plugins&gt;</span>
        <span class="kw">&lt;plugin&gt;</span>
            <span class="kw">&lt;groupId&gt;</span>org.javalite<span class="kw">&lt;/groupId&gt;</span>
            <span class="kw">&lt;artifactId&gt;</span>db-migrator-maven-plugin<span class="kw">&lt;/artifactId&gt;</span>
            <span class="kw">&lt;version&gt;</span>1.4.9<span class="kw">&lt;/version&gt;</span>
            <span class="kw">&lt;configuration&gt;</span>
                <span class="kw">&lt;username&gt;</span>${jdbc.user}<span class="kw">&lt;/username&gt;</span>
                <span class="kw">&lt;password&gt;</span>${jdbc.password}<span class="kw">&lt;/password&gt;</span>
                <span class="kw">&lt;driver&gt;</span>${jdbc.driver}<span class="kw">&lt;/driver&gt;</span>
            <span class="kw">&lt;/configuration&gt;</span>
            <span class="kw">&lt;dependencies&gt;</span>
                <span class="kw">&lt;dependency&gt;</span>
                    <span class="kw">&lt;groupId&gt;</span>mysql<span class="kw">&lt;/groupId&gt;</span>
                    <span class="kw">&lt;artifactId&gt;</span>mysql-connector-java<span class="kw">&lt;/artifactId&gt;</span>
                    <span class="kw">&lt;version&gt;</span>5.1.25<span class="kw">&lt;/version&gt;</span>
                <span class="kw">&lt;/dependency&gt;</span>
            <span class="kw">&lt;/dependencies&gt;</span>
        <span class="kw">&lt;/plugin&gt;</span>
    <span class="kw">&lt;/plugins&gt;</span>
<span class="kw">&lt;/pluginManagement&gt;</span></code></pre>
<p>where user, password and driver are configured as project properties.</p>
<p>After that, you can configure the plugin to execute multiple databases by adding many executions. Here is example of one execution:</p>
<pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;plugin&gt;</span>
    <span class="kw">&lt;groupId&gt;</span>org.javalite<span class="kw">&lt;/groupId&gt;</span>
    <span class="kw">&lt;artifactId&gt;</span>db-migrator-maven-plugin<span class="kw">&lt;/artifactId&gt;</span>
    <span class="kw">&lt;executions&gt;</span>
        <span class="kw">&lt;execution&gt;</span>
            <span class="kw">&lt;id&gt;</span>dev_migrations<span class="kw">&lt;/id&gt;</span>
            <span class="kw">&lt;phase&gt;</span>validate<span class="kw">&lt;/phase&gt;</span>
            <span class="kw">&lt;goals&gt;</span>
                <span class="kw">&lt;goal&gt;</span>migrate<span class="kw">&lt;/goal&gt;</span>
            <span class="kw">&lt;/goals&gt;</span>
        <span class="kw">&lt;/execution&gt;</span>
        <span class="kw">&lt;execution&gt;</span>
            <span class="kw">&lt;id&gt;</span>test_migrations<span class="kw">&lt;/id&gt;</span>
            <span class="kw">&lt;phase&gt;</span>validate<span class="kw">&lt;/phase&gt;</span>
            <span class="kw">&lt;goals&gt;</span>
                <span class="kw">&lt;goal&gt;</span>migrate<span class="kw">&lt;/goal&gt;</span>
            <span class="kw">&lt;/goals&gt;</span>
            <span class="kw">&lt;configuration&gt;</span>
                <span class="kw">&lt;url&gt;</span>${jdbc.test.url}<span class="kw">&lt;/url&gt;</span>
            <span class="kw">&lt;/configuration&gt;</span>
        <span class="kw">&lt;/execution&gt;</span>
    <span class="kw">&lt;/executions&gt;</span>
<span class="kw">&lt;/plugin&gt;</span></code></pre>
<p>As you can see, the plugin tied to validate phase, which will ensure that it will migrate schema at the very start of the build. Add more executions to run against multiple databases. You can use Maven profiles with this plugin to migrate databases in different environments, such as production.</p>
<h2 id="configuration-properties">Configuration properties</h2>
<ul>
<li><code>url</code> - JDBC connection URL</li>
<li><code>driver</code> - JDBC connection driver</li>
<li><code>username</code> - JDBC connection user name</li>
<li><code>password</code> - JDBC connection password</li>
<li><code>migrationsPath</code> - location of migration files, defaults to <code>src/migrations/</code></li>
<li><code>createSql</code> - create database SQL, defaults to <code>create database {$your database}</code></li>
<li><code>dropSql</code> - drop database SQL, defaults to <code>drop database {$your database}</code></li>
</ul>
<p>DB-Migrator maintains a record of executing migrations in table SCHEMA_VERSION and will not execute the same migration twice:</p>
<pre class="prettyprint"><code>mysql&gt; select * from schema_version;</code></pre>
<p>Results in the following output:</p>
<table>
<col width="23%" />
<col width="30%" />
<col width="15%" />
<thead>
<tr class="header">
<th align="left">version</th>
<th align="left">applied_on</th>
<th align="left">duration</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">20140302193112</td>
<td align="left">2014-07-03 22:08:41</td>
<td align="left">22</td>
</tr>
<tr class="even">
<td align="left">20140302193141</td>
<td align="left">2014-07-03 22:08:41</td>
<td align="left">12</td>
</tr>
<tr class="odd">
<td align="left">20140303150340</td>
<td align="left">2014-07-03 22:08:41</td>
<td align="left">13</td>
</tr>
<tr class="even">
<td align="left">20140304173708</td>
<td align="left">2014-07-03 22:08:41</td>
<td align="left">20</td>
</tr>
<tr class="odd">
<td align="left">20140304174236</td>
<td align="left">2014-07-03 22:08:41</td>
<td align="left">18</td>
</tr>
<tr class="even">
<td align="left">20140305235518</td>
<td align="left">2014-07-03 22:08:41</td>
<td align="left">13</td>
</tr>
<tr class="odd">
<td align="left">20140306002924</td>
<td align="left">2014-07-03 22:08:41</td>
<td align="left">12</td>
</tr>
<tr class="even">
<td align="left">20140307192002</td>
<td align="left">2014-07-03 22:08:41</td>
<td align="left">25</td>
</tr>
<tr class="odd">
<td align="left">20140309143448</td>
<td align="left">2014-07-03 22:08:41</td>
<td align="left">25</td>
</tr>
<tr class="even">
<td align="left">20140310141755</td>
<td align="left">2014-07-03 22:08:41</td>
<td align="left">25</td>
</tr>
</tbody>
</table>
<h1 id="development-process">Development process</h1>
<p>Since all migrations are recorded as text (SQL) files, and contain a time stamp in the name, every time a developer pulls sources from source repository and execute a build, your database is upgraded to the latest migration automatically. In our experience, this reduced amount of attention we had to give a DB to a minimum. Basically a developer creates a new migration and checks it in, which makes it propagate to other developer machines automatically.</p>
<h1 id="maintaining-multiple-databases">Maintaining multiple databases</h1>
<p>You can use Maven profiles to maintain multiple database, as well as specific configuration for different executions of the same plugin. Please see <a href="https://github.com/javalite/kitchensink/">ActiveWeb Kitchensik</a> project for example of multiple plugin executions.</p>
